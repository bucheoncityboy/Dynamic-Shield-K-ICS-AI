# Dynamic Shield v3.0 í™•ìž¥ êµ¬í˜„ ê³„íšì„œ

## User Review Required

> [!IMPORTANT]
> **ê¸°ì¡´ ì½”ë“œëŠ” ìˆ˜ì • ìµœì†Œí™”**, ëŒ€ë¶€ë¶„ **ì‹ ê·œ íŒŒì¼ ì¶”ê°€** ë°©ì‹ìœ¼ë¡œ ì§„í–‰
> - ì‹ ê·œ íŒŒì¼: 7ê°œ
> - ê¸°ì¡´ íŒŒì¼ ìˆ˜ì •: 2ê°œ (`kics_real.py`, `backtest.py`)

---

## Proposed Changes

### Phase 1: ê¸°ë°˜ êµ¬ì¡°

---

#### [NEW] [risk_control.py](file:///c:/Users/PC/Desktop/Quant/í•œí™”/Dynamic-Shield-K-ICS-AI/src/safety/risk_control.py)

**ë…ë¦½ Risk Control ëª¨ë“ˆ** - Safety Layerë¥¼ ë³„ë„ ëª¨ë“ˆë¡œ ë¶„ë¦¬

```python
class RiskController:
    def __init__(self, config):
        self.vix_threshold = config.get('vix_threshold', 40)
        self.max_step_change = config.get('max_step', 0.15)
        self.min_kics = config.get('min_kics', 100)
    
    def apply_safety_rules(self, action, state):
        # VIX > 40: Emergency De-risking
        # K-ICS < 100%: Force 100% Hedge
        # Max step: Â±15% per period
        ...
```

---

#### [NEW] [main.py](file:///c:/Users/PC/Desktop/Quant/í•œí™”/Dynamic-Shield-K-ICS-AI/src/main.py)

**í†µí•© ì‹¤í–‰ ìŠ¤í¬ë¦½íŠ¸** - CLI ê¸°ë°˜ ì˜¤ì¼€ìŠ¤íŠ¸ë ˆì´ì…˜

```bash
# ì‚¬ìš© ì˜ˆì‹œ
python main.py --mode train      # PPO í•™ìŠµ
python main.py --mode backtest   # ë°±í…ŒìŠ¤íŠ¸
python main.py --mode live       # ì‹¤ì‹œê°„ ìš´ì˜
python main.py --mode validate   # ì‹œìŠ¤í…œ ê²€ì¦
```

---

#### [NEW] [latency.py](file:///c:/Users/PC/Desktop/Quant/í•œí™”/Dynamic-Shield-K-ICS-AI/src/realtime/latency.py)

**ì§€ì—°ì‹œê°„ ì¸¡ì • ìœ í‹¸ë¦¬í‹°**

```python
class LatencyMonitor:
    def measure(self, func):
        """ë°ì½”ë ˆì´í„°: í•¨ìˆ˜ ì‹¤í–‰ ì‹œê°„ ì¸¡ì •"""
        ...
    
    def report(self):
        """í†µê³„: í‰ê· , P95, P99 ì§€ì—°ì‹œê°„"""
        ...
```

---

### Phase 2: í•µì‹¬ ê¸°ëŠ¥

---

#### [NEW] [async_engine.py](file:///c:/Users/PC/Desktop/Quant/í•œí™”/Dynamic-Shield-K-ICS-AI/src/realtime/async_engine.py)

**ë¹„ë™ê¸° ì•„í‚¤í…ì²˜ (Fast/Slow Track ë¶„ë¦¬)**

| Track | ì—­í•  | ìŠ¤ë ˆë“œ |
|---|---|---|
| **Fast** | ì¶”ë¡  (predict) | Main Thread |
| **Slow** | í•™ìŠµ (learn) | Background Thread |

```python
class AsyncEngine:
    def __init__(self):
        self.current_model = PPO.load("model.zip")
        self.model_lock = threading.Lock()
    
    def predict(self, obs):          # Fast: ì¦‰ì‹œ ì‘ë‹µ
        with self.model_lock:
            return self.current_model.predict(obs)
    
    def train_async(self, env):      # Slow: ë°±ê·¸ë¼ìš´ë“œ
        thread = threading.Thread(target=self._train, args=(env,))
        thread.start()
```

---

#### [MODIFY] [kics_real.py](file:///c:/Users/PC/Desktop/Quant/í•œí™”/Dynamic-Shield-K-ICS-AI/src/core/kics_real.py)

**Duration Gap ë™ì  ì¡°ì •** - ê¸°ì¡´ ê³ ì •ê°’ì„ ë™ì ìœ¼ë¡œ ë³€ê²½ ê°€ëŠ¥í•˜ê²Œ í™•ìž¥

```diff
class KICSCalculator:
    def __init__(self):
-       self.dur_asset = 8.0   # ê³ ì •
-       self.dur_liab = 10.0   # ê³ ì •
+       self.dur_asset = 8.0   # ê¸°ë³¸ê°’
+       self.dur_liab = 10.0   # ê¸°ë³¸ê°’
    
+   def update_duration(self, dur_asset, dur_liab):
+       """ALM ê´€ì  Duration Gap ë™ì  ì¡°ì •"""
+       self.dur_asset = dur_asset
+       self.dur_liab = dur_liab
+       self.duration_gap = dur_liab - dur_asset
```

---

#### [NEW] [intraday.py](file:///c:/Users/PC/Desktop/Quant/í•œí™”/Dynamic-Shield-K-ICS-AI/src/realtime/intraday.py)

**Intra-day Estimation** - ìž¥ì¤‘ ë°ì´í„°ë¥¼ ì¼ë´‰ ê¸°ë°˜ ëª¨ë¸ì— ìž…ë ¥

```python
class IntradayEstimator:
    def __init__(self, daily_model):
        self.model = daily_model
    
    def estimate_from_tick(self, tick_data, last_daily_close):
        """
        ìž¥ì¤‘ í‹± ë°ì´í„° â†’ ì¼ë´‰ í”¼ì²˜ ì¶”ì • â†’ ëª¨ë¸ ì¶”ë¡ 
        - VIX: ì‹¤ì‹œê°„ VIX ì‚¬ìš©
        - Correlation: ìµœê·¼ Në¶„ ë¡¤ë§ ìƒê´€ê³„ìˆ˜
        - FX: ì‹¤ì‹œê°„ í™˜ìœ¨ â†’ ì „ì¼ ëŒ€ë¹„ ë³€ë™ë¥ 
        """
        ...
```

---

### Phase 3: ê²€ì¦ & ìš´ì˜

---

#### [MODIFY] [backtest.py](file:///c:/Users/PC/Desktop/Quant/í•œí™”/Dynamic-Shield-K-ICS-AI/src/validation/backtest.py)

**Walk-Forward Analysis (Rolling Window)** ì¶”ê°€

```diff
class BacktestEngine:
+   def run_walk_forward(self, data, train_window=252, test_window=63):
+       """
+       Rolling Window ë°©ì‹ Walk-Forward ë¶„ì„
+       - train_window: í•™ìŠµ ê¸°ê°„ (ê¸°ë³¸ 1ë…„)
+       - test_window: í…ŒìŠ¤íŠ¸ ê¸°ê°„ (ê¸°ë³¸ 1ë¶„ê¸°)
+       - ìž¬í•™ìŠµ ì£¼ê¸°: test_windowë§ˆë‹¤ ëª¨ë¸ ì—…ë°ì´íŠ¸
+       """
+       results = []
+       for start in range(0, len(data) - train_window - test_window, test_window):
+           train_data = data[start:start + train_window]
+           test_data = data[start + train_window:start + train_window + test_window]
+           # í•™ìŠµ â†’ í…ŒìŠ¤íŠ¸ â†’ ê²°ê³¼ ìˆ˜ì§‘
+           ...
+       return results
```

---

#### [NEW] [system_validation.py](file:///c:/Users/PC/Desktop/Quant/í•œí™”/Dynamic-Shield-K-ICS-AI/src/validation/system_validation.py)

**System Latency & Surrogate ì˜¤ì°¨ìœ¨ í†µí•© ê²€ì¦**

```python
def validate_system():
    results = {
        'surrogate_mape': test_surrogate_accuracy(),  # ëª©í‘œ: < 1%
        'inference_latency_p95': test_inference_latency(),  # ëª©í‘œ: < 50ms
        'safety_layer_response': test_safety_layer(),  # ëª©í‘œ: ì¦‰ì‹œ ìž‘ë™
    }
    return results
```

---

#### [NEW] [live_mode.py](file:///c:/Users/PC/Desktop/Quant/í•œí™”/Dynamic-Shield-K-ICS-AI/src/realtime/live_mode.py)

**ì‹¤ì‹œê°„ ìš´ì˜ ëª¨ë“œ**

```python
class LiveTradingLoop:
    def __init__(self):
        self.engine = AsyncEngine()
        self.risk_controller = RiskController()
        self.latency_monitor = LatencyMonitor()
    
    def run(self, data_source, interval_sec=10):
        """ì‹¤ì‹œê°„ ë£¨í”„: ë°ì´í„° ìˆ˜ì‹  â†’ ì¶”ë¡  â†’ ì•ˆì „ ê²€ì‚¬ â†’ ì¶œë ¥"""
        while True:
            data = data_source.get_latest()
            action = self.engine.predict(data)
            safe_action = self.risk_controller.apply_safety_rules(action, data)
            print(f"ì¶”ì²œ í—¤ì§€ ë¹„ìœ¨: {safe_action*100:.1f}%")
            time.sleep(interval_sec)
```

---

## ìµœì¢… í´ë” êµ¬ì¡°

```
src/
â”œâ”€â”€ core/                    # ê¸°ì¡´ ìœ ì§€
â”‚   â”œâ”€â”€ kics_real.py         # âœï¸ Duration Gap ë©”ì„œë“œ ì¶”ê°€
â”‚   â””â”€â”€ ...
â”‚
â”œâ”€â”€ safety/                  # ðŸ†• ì‹ ê·œ
â”‚   â”œâ”€â”€ __init__.py
â”‚   â””â”€â”€ risk_control.py
â”‚
â”œâ”€â”€ realtime/                # ðŸ†• ì‹ ê·œ
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ async_engine.py
â”‚   â”œâ”€â”€ intraday.py
â”‚   â”œâ”€â”€ latency.py
â”‚   â””â”€â”€ live_mode.py
â”‚
â”œâ”€â”€ validation/              # ê¸°ì¡´ + í™•ìž¥
â”‚   â”œâ”€â”€ backtest.py          # âœï¸ Walk-Forward ì¶”ê°€
â”‚   â””â”€â”€ system_validation.py # ðŸ†• ì‹ ê·œ
â”‚
â””â”€â”€ main.py                  # ðŸ†• ì‹ ê·œ
```

---

## Verification Plan

### Automated Tests

```bash
# 1. ì‹œìŠ¤í…œ ê²€ì¦ ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰
python src/validation/system_validation.py

# ê¸°ëŒ€ ê²°ê³¼:
# - Surrogate MAPE: < 1%
# - Inference Latency P95: < 50ms
# - Safety Layer: PASS
```

```bash
# 2. Walk-Forward ë°±í…ŒìŠ¤íŠ¸
python src/validation/backtest.py --walk-forward

# ê¸°ëŒ€ ê²°ê³¼:
# - Rolling windowë³„ ì„±ê³¼ ì¶œë ¥
# - ì‹œê³„ì—´ ì¼ê´€ì„± í™•ì¸
```

```bash
# 3. ë¹„ë™ê¸° ì—”ì§„ í…ŒìŠ¤íŠ¸
python src/realtime/async_engine.py

# ê¸°ëŒ€ ê²°ê³¼:
# - ë°±ê·¸ë¼ìš´ë“œ í•™ìŠµ ì¤‘ì—ë„ predict() ì¦‰ì‹œ ì‘ë‹µ
# - "í•™ìŠµ ì¤‘ ì¶”ë¡  ê°€ëŠ¥" ë©”ì‹œì§€ ì¶œë ¥
```

### Manual Verification

1. **ì‹¤ì‹œê°„ ëª¨ë“œ í…ŒìŠ¤íŠ¸**
   ```bash
   python src/main.py --mode live --interval 5
   ```
   - 5ì´ˆë§ˆë‹¤ "ì¶”ì²œ í—¤ì§€ ë¹„ìœ¨: XX%" ì¶œë ¥ í™•ì¸
   - Ctrl+Cë¡œ ì •ìƒ ì¢…ë£Œ í™•ì¸

2. **Duration Gap ë™ì  ì¡°ì • í™•ì¸**
   - `kics_real.py`ì˜ `update_duration()` í˜¸ì¶œ í›„ SCR ê°’ ë³€í™” í™•ì¸


---

## ê° í•­ëª©ì˜ ëª©ì 

|---|---|---|
| 1 | Risk Control ë¶„ë¦¬ | Safety Layer íŒŒë¼ë¯¸í„° ë³€ê²½ ì‹œ ë…ë¦½ ìˆ˜ì • ê°€ëŠ¥ |
| 2 | main.py | CLIë¡œ ì „ì²´ íŒŒì´í”„ë¼ì¸ ìžë™í™” |
| 3 | ì§€ì—°ì‹œê°„ ì¸¡ì • | "ì‹¤ì‹œê°„" ì£¼ìž¥ì˜ ì •ëŸ‰ì  ì¦ê±° |
| 4 | ë¹„ë™ê¸° ì•„í‚¤í…ì²˜ | í•™ìŠµ ì¤‘ì—ë„ ì¶”ë¡  ê°€ëŠ¥ (ìœ„ê¸° ëŒ€ì‘) |
| 5 | Duration Gap ë™ì  | ALM ê´€ì  ìžì‚°-ë¶€ì±„ ë§¤ì¹­ ìµœì í™” |
| 6 | Intra-day | ìž¥ì¤‘ ë°ì´í„°ë¡œ ì¦‰ì‹œ ì¶”ë¡  |
| 7 | Walk-Forward | ê³¼ì í•© ë°©ì§€, ì¼ë°˜í™” ì„±ëŠ¥ ê²€ì¦ |
| 8 | System Validation | Surrogate/Latency ì§€ì† ëª¨ë‹ˆí„°ë§ |
| 9 | ì‹¤ì‹œê°„ ëª¨ë“œ | ì‹¤ì œ ìš´ì˜ ì‹œë‚˜ë¦¬ì˜¤ ì§€ì› |
